# Discord 平台使用指南

## 🎮 Discord 上的使用体验

本插件针对 Discord 平台进行了特别优化，提供最佳的视频播放体验。

## ✨ 功能特性

### 1. 原生视频播放器支持

插件在 Discord 上使用**视频组件**发送视频，触发 Discord 的原生媒体播放器：

- ✅ **点击播放**：直接点击视频即可播放
- ✅ **音频支持**：完整支持视频音轨播放
- ✅ **媒体控制**：暂停/播放、音量调节、进度条拖拽
- ✅ **全屏模式**：支持全屏观看视频
- ✅ **画质选择**：Discord 自动适配画质

### 2. 自动降级机制

如果视频组件发送失败（极少数情况），插件会自动降级：

- 📎 发送视频链接
- 🎬 Discord 仍会自动嵌入视频预览
- 🔊 用户依然可以点击播放

### 3. 播放进度追踪

- 📊 显示本轮已播放视频数量
- 🔄 所有视频播放完后自动开始新一轮
- 🎲 同一轮内不会重复播放相同视频

## 🎯 使用方法

### 基础命令

```
/rv                    # 随机播放一个视频（推荐）
/randomvideo          # 同上（完整命令）
/随机视频              # 中文命令

/videoinfo            # 查看视频库信息
/视频信息              # 中文命令

/reloadvideos         # 重新加载视频列表（仅管理员）
/重载视频              # 中文命令
```

### 使用流程

1. **发送命令**
   ```
   用户: /rv
   ```

2. **Bot 返回视频**
   ```
   Bot: [Discord 原生视频播放器]
        📊 本轮已播放: 3/10
        💡 发送 '/rv' 获取下一个视频
   ```

3. **观看视频**
   - 点击视频播放按钮
   - 调整音量
   - 全屏观看（可选）

4. **获取下一个**
   - 再次发送 `/rv`
   - 获得新的随机视频

## 📺 视频展示效果

### 标准视频消息

```
┌─────────────────────────────────────┐
│  🤖 Bot 名称                         │
│                                     │
│  ┌─────────────────────────────┐   │
│  │                             │   │
│  │      [视频播放器界面]        │   │
│  │                             │   │
│  │    ▶️ 播放按钮 | 🔊 音量     │   │
│  │                             │   │
│  └─────────────────────────────┘   │
│                                     │
│  📊 本轮已播放: 3/10                 │
│  💡 发送 '/rv' 获取下一个视频         │
│                                     │
│  今天 14:23                          │
└─────────────────────────────────────┘
```

### 特点说明

- **嵌入式播放器**：视频直接在聊天中显示
- **一键播放**：点击播放按钮即可
- **清晰提示**：播放进度和操作提示一目了然

## 🔧 技术实现

### 视频组件发送

```python
# Discord 平台使用视频组件
if platform_name.lower() == "discord":
    message_chain.append(Comp.Video.fromURL(url=video_url))
```

### 降级处理

```python
# 如果视频组件失败，自动降级为链接
except Exception as e:
    logger.warning(f"Discord 视频组件发送失败，降级为链接: {str(e)}")
    message_chain.append(Comp.Plain(f"🎬 随机视频:\n{video_url}"))
```

### 支持的视频格式

Discord 原生支持的视频格式：
- ✅ MP4 (H.264/H.265)
- ✅ WebM
- ✅ MOV
- ✅ AVI
- ✅ MKV

**建议**：优先使用 MP4 格式，兼容性最好

## 📊 播放统计

### 会话隔离

每个 Discord 频道/私聊都有独立的播放历史：

```
服务器 A - #视频频道
  └─ 播放历史: [video1, video2, video3]

服务器 B - #娱乐频道
  └─ 播放历史: [video1]

私聊 - @用户C
  └─ 播放历史: [video2, video4]
```

### 防重复机制

```
第一轮：
  已播放: [video1, video2, video3]
  剩余: [video4, video5]

  用户发送: /rv
  返回: video4 或 video5

第二轮：（所有视频播放完后）
  已播放: []  # 自动清空
  剩余: [video1, video2, video3, video4, video5]

  用户发送: /rv
  返回: 任意随机视频
```

## 🎨 使用场景

### 1. 娱乐频道

在 Discord 服务器的娱乐频道分享随机搞笑视频：

```
用户A: /rv
Bot: [发送搞笑猫咪视频]

用户B: 😂 太好笑了！

用户A: /rv
Bot: [发送另一个随机视频]
```

### 2. 视频分享

在频道中随机分享视频合集：

```
管理员: 大家来看看随机视频吧！

用户: /rv
Bot: [随机播放视频库中的一个视频]
     📊 本轮已播放: 1/50
```

### 3. 私聊互动

在私聊中分享视频：

```
用户: /rv
Bot: [发送随机视频]

用户: 这个不错，再来一个
用户: /rv
Bot: [发送另一个视频]
```

## ⚙️ 配置建议

### 视频 URL 要求

确保视频 URL 符合以下要求：

1. **可公开访问**：URL 不需要认证
2. **HTTPS 协议**：Discord 要求使用 HTTPS
3. **直链格式**：URL 直接指向视频文件，不是网页

✅ **正确示例**：
```
https://cdn.example.com/videos/funny_cat.mp4
https://example.oss-cn-hangzhou.aliyuncs.com/video.mp4
```

❌ **错误示例**：
```
http://example.com/video.mp4          # 不是 HTTPS
https://example.com/watch?v=abc123    # 不是直链
https://example.com/player.html       # 指向网页
```

### CDN 推荐

使用 CDN 加速视频加载，提升体验：

- **Cloudflare CDN**（推荐）：免费、全球加速
- **阿里云 CDN**：国内访问快
- **AWS CloudFront**：全球分发

配置示例（在 OSS 同步脚本中）：
```env
OSS_CUSTOM_DOMAIN=https://cdn.example.com
```

### 视频大小建议

Discord 对视频大小有限制：

- **常规用户**：最大 8MB
- **Nitro 用户**：最大 50MB（Discord Nitro Classic）或 100MB（Discord Nitro）

**建议**：
- 保持视频在 8MB 以内，确保所有用户都能观看
- 使用视频压缩工具优化大小
- 考虑使用更高效的编码格式（H.265）

## 🔍 常见问题

### Q: 视频无法播放？

**检查清单**：
1. ✅ URL 是否使用 HTTPS 协议
2. ✅ URL 是否可公开访问（无需认证）
3. ✅ 视频格式是否被 Discord 支持
4. ✅ 视频大小是否超过限制

**解决方法**：
```bash
# 测试 URL 是否可访问
curl -I https://your-video-url.mp4

# 检查视频格式和大小
ffprobe https://your-video-url.mp4
```

### Q: 视频卡顿或加载慢？

**原因**：
- 视频文件过大
- CDN 未配置或速度慢
- 网络连接问题

**解决方法**：
1. 压缩视频文件
2. 使用 CDN 加速（如 Cloudflare）
3. 选择更近的 OSS 区域

### Q: 没有音频？

**检查**：
- 视频源文件是否包含音轨
- Discord 是否静音
- 系统音量设置

**测试**：
```bash
# 检查视频是否有音轨
ffprobe -show_streams https://your-video-url.mp4 | grep audio
```

### Q: 想要切换视频但没有按钮？

**解释**：
AstrBot 框架目前不支持 Discord 交互式按钮（Button、SelectMenu 等）

**替代方案**：
- 使用斜杠命令：`/rv` 获取新视频
- 命令简短，输入方便
- 功能效果相同

### Q: 如何让所有人都能使用？

**权限设置**：
1. 在 Discord 服务器设置中
2. 找到 Bot 的角色权限
3. 确保在目标频道有以下权限：
   - "查看频道"
   - "发送消息"
   - "嵌入链接"
   - "附加文件"（用于视频）

## 📈 最佳实践

### 1. 视频库管理

- 🎯 **分类管理**：不同类型视频放在不同 JSON 文件
- 📝 **定期更新**：使用 OSS 同步脚本自动添加新视频
- 🧹 **清理失效**：定期检查并移除失效链接

### 2. 用户体验优化

- ⚡ **快速加载**：使用 CDN，优化视频大小
- 📱 **移动友好**：确保视频在手机端也能流畅播放
- 🔊 **音量适中**：源视频音量不要过大或过小

### 3. 服务器管理

- 👥 **专用频道**：创建专门的视频分享频道
- 🎮 **游戏化**：设置"每日随机视频"活动
- 📊 **统计分析**：记录受欢迎的视频类型

## 🚀 进阶技巧

### 自定义命令前缀

在 Discord 服务器中设置自定义前缀（如果 Bot 支持）：

```
!video     # 替代 /rv
!nextvideo # 获取下一个
```

### 批量导入视频

使用 OSS 同步脚本快速导入大量视频：

```bash
# 扫描整个 OSS bucket
python scripts/sync_oss_videos.py

# 自动生成 videos.json
# 一次性导入数百个视频
```

### 多服务器共享

一个 JSON URL 可以被多个 Discord 服务器共享：

```
服务器 A: video_json_url=https://cdn.example.com/videos.json
服务器 B: video_json_url=https://cdn.example.com/videos.json
服务器 C: video_json_url=https://cdn.example.com/videos.json
```

## 📝 总结

Discord 平台上的随机视频插件特点：

✅ **原生播放器** - 完整的音视频播放体验
✅ **自动降级** - 确保在各种情况下都能工作
✅ **简单易用** - 一个命令即可使用
✅ **防重复** - 智能避免重复播放
✅ **高性能** - CDN 加速，快速加载

开始在您的 Discord 服务器上使用吧！🎉
